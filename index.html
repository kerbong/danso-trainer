<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Îã®ÏÜå Ïó∞Ï£º ÌïôÏäµ ÎèÑÏö∞ÎØ∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button.primary {
            background: #667eea;
            color: white;
        }

        button.primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        button.secondary {
            background: #48bb78;
            color: white;
        }

        button.secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72,187,120,0.4);
        }

        button.danger {
            background: #f56565;
            color: white;
        }

        button.danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245,101,101,0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        button.hidden {
            display: none;
        }

        .feedback-section {
            margin-top: 20px;
        }

        .feedback-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #cbd5e0;
        }

        .feedback-item.good {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .feedback-item.warning {
            border-left-color: #ed8936;
            background: #fffaf0;
        }

        .feedback-item.error {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .feedback-item h3 {
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .feedback-item p {
            color: #4a5568;
            font-size: 0.95rem;
        }

        #audioVisualization {
            width: 100%;
            height: 150px;
            background: #000;
            border-radius: 10px;
            margin-top: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #48bb78;
            box-shadow: 0 0 10px #48bb78;
        }

        .status-indicator.inactive {
            background: #cbd5e0;
        }

        .instructions {
            grid-column: 1 / -1;
        }

        .instruction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .instruction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .instruction-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .instruction-card p {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .step-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 6px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .step-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
        }

        .step-description {
            color: #4a5568;
            line-height: 1.8;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .step-tips {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #48bb78;
        }

        .step-tips h4 {
            color: #48bb78;
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .step-tips ul {
            margin-left: 20px;
            color: #4a5568;
            line-height: 1.6;
        }

        .step-tips li {
            margin-bottom: 5px;
        }

        .pitch-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .video-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-link-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .video-link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
        }

        .video-link-card a {
            color: white;
            text-decoration: none;
            display: block;
        }

        .video-link-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .video-link-card p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .video-link-card .btn {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .video-link-card .btn:hover {
            background: #f7fafc;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Îã®ÏÜå Ïó∞Ï£º ÌïôÏäµ ÎèÑÏö∞ÎØ∏</h1>

        <div class="main-grid">
            <!-- ÏõπÏ∫† ÏÑπÏÖò -->
            <div class="card">
                <h2>
                    <span class="status-indicator" id="cameraStatus"></span>
                    Ïã§ÏãúÍ∞Ñ ÏûÖÏà† Î™®Ïñë Î∂ÑÏÑù
                </h2>
                <div id="videoContainer">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <div class="controls">
                    <button class="primary" id="startCamera">Ïπ¥Î©îÎùº ÏãúÏûë</button>
                    <button class="danger hidden" id="stopCamera">Ïπ¥Î©îÎùº Ï§ëÏßÄ</button>
                </div>
                <div id="lipFeedback" class="feedback-section"></div>
            </div>

            <!-- Ïò§ÎîîÏò§ Î∂ÑÏÑù ÏÑπÏÖò -->
            <div class="card">
                <h2>
                    <span class="status-indicator" id="micStatus"></span>
                    ÏÜåÎ¶¨ Î∂ÑÏÑù
                </h2>
                <canvas id="audioVisualization"></canvas>
                <div class="pitch-display" id="pitchDisplay">
                    ÏùåÎÜíÏù¥: --
                </div>
                <div class="controls">
                    <button class="secondary" id="startAudio">ÎßàÏù¥ÌÅ¨ ÏãúÏûë</button>
                    <button class="danger hidden" id="stopAudio">ÎßàÏù¥ÌÅ¨ Ï§ëÏßÄ</button>
                </div>
                <div id="audioFeedback" class="feedback-section"></div>
            </div>

            <!-- Îã®Í≥ÑÎ≥Ñ ÌïôÏäµ Í∞ÄÏù¥Îìú -->
            <div class="card instructions">
                <h2>üìö Îã®ÏÜå Ïó∞Ï£º 4Îã®Í≥Ñ ÌïôÏäµ Í∞ÄÏù¥Îìú</h2>

                <div class="step-card">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">ÏûÖÏà† ÏùºÏûêÎ°ú ÎßåÎì§Ïñ¥ Î∞îÎûåÎÇ¥Í∏∞</div>
                    </div>
                    <p class="step-description">
                        Îã®ÏÜå ÏóÜÏù¥ Î®ºÏ†Ä ÏûÖÏà†Î°úÎßå Î∞îÎûåÏùÑ ÎßåÎìúÎäî Ïó∞ÏäµÏùÑ Ìï©ÎãàÎã§.
                        ÏûÖÏà†ÏùÑ "Ìúò" Î∞úÏùåÌïòÎìØÏù¥ ÏñëÏ™ΩÏúºÎ°ú ÎÑìÍ≤å Ìé¥Í≥†, ÏûÖ Ï§ëÏïôÏóê ÏûëÏùÄ Íµ¨Î©çÏùÑ ÎßåÎì§Ïñ¥ Î∞îÎûåÏùÑ ÎÇ¥Î≥¥ÎÉÖÎãàÎã§.
                    </p>
                    <div class="step-tips">
                        <h4>üí° ÌïµÏã¨ Ìè¨Ïù∏Ìä∏</h4>
                        <ul>
                            <li>ÏûÖÏà†ÏùÑ Ï¢åÏö∞Î°ú ÎÑìÍ≤å Ìé¥ÏÑú ÏùºÏûêÎ°ú ÎßåÎì§Í∏∞</li>
                            <li>ÏûÖÍº¨Î¶¨Ïóê ÌûòÏùÑ Ï£ºÏñ¥ Í≥µÍ∏∞Í∞Ä ÏÉàÏßÄ ÏïäÎèÑÎ°ù ÌïòÍ∏∞</li>
                            <li>ÏûÖ Ï§ëÏïôÏóêÏÑú ÎÇòÏò§Îäî Î∞îÎûå Íµ¨Î©çÏù¥ Ìïú ÏÜêÍ∞ÄÎùΩÏúºÎ°ú ÎßâÌûê Ï†ïÎèÑÎ°ú ÏûëÍ≤å ÎßåÎì§Í∏∞</li>
                            <li>Î∂ÄÎìúÎüΩÍ≤å "ÌõÑ~" ÏÜåÎ¶¨ÎÇ¥Î©∞ Î∞îÎûå Î∂àÏñ¥Î≥¥Í∏∞</li>
                        </ul>
                    </div>
                </div>

                <div class="step-card">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">Î∞îÎûåÍµ¨Î©ç ÏúÑÏπò ÌôïÏù∏ÌïòÍ∏∞</div>
                    </div>
                    <p class="step-description">
                        Í±∞Ïö∏ÏùÑ Î≥¥Î©¥ÏÑú ÏûêÏã†Ïùò Î∞îÎûå Íµ¨Î©çÏù¥ Ï†ïÌôïÌûà Ïñ¥ÎîîÏóê ÏúÑÏπòÌïòÎäîÏßÄ ÌôïÏù∏Ìï©ÎãàÎã§.
                        ÏÜêÍ∞ÄÎùΩÏúºÎ°ú ÏûÖÏà† Ï§ëÏïôÏùÑ Í∞ÄÎ≥çÍ≤å ÎåÄÎ≥¥Î©∞ Î∞îÎûåÏù¥ ÎÇòÏò§Îäî ÏúÑÏπòÎ•º ÌååÏïÖÌïòÏÑ∏Ïöî.
                    </p>
                    <div class="step-tips">
                        <h4>üí° ÌïµÏã¨ Ìè¨Ïù∏Ìä∏</h4>
                        <ul>
                            <li>Í±∞Ïö∏ÏùÑ Ï†ïÎ©¥ÏúºÎ°ú Î≥¥Í≥† ÏûÖÏà† Î™®Ïñë Í¥ÄÏ∞∞ÌïòÍ∏∞</li>
                            <li>ÏÜêÍ∞ÄÎùΩÏùÑ ÏûÖÏà† Ï§ëÏïôÏóê ÎåÄÍ≥† Î∞îÎûåÏù¥ ÎãøÎäî ÏúÑÏπò ÌôïÏù∏ÌïòÍ∏∞</li>
                            <li>Î∞îÎûå Íµ¨Î©çÏù¥ Ï†ïÌôïÌûà ÏûÖÏà† Ï§ëÏïôÏóê ÏúÑÏπòÌïòÎäîÏßÄ Ï≤¥ÌÅ¨ÌïòÍ∏∞</li>
                            <li>Ïπ¥Î©îÎùºÎ•º ÏºúÍ≥† ÏúÑ ÌôîÎ©¥ÏóêÏÑú Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏûÖÏà† Î™®Ïñë ÌôïÏù∏ÌïòÍ∏∞</li>
                        </ul>
                    </div>
                </div>

                <div class="step-card">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">Îã®ÏÜå ÏûÖÏà†Ïóê ÎåÄÍ∏∞</div>
                    </div>
                    <p class="step-description">
                        Ïù¥Ï†ú Îã®ÏÜåÎ•º ÏïÑÎû´ÏûÖÏà† ÎÅùÏóê Í∞ÄÎ≥çÍ≤å ÎåëÎãàÎã§.
                        Îã®ÏÜåÏùò Ï∑®Íµ¨(Î∂àÍµ¨Î©ç)Í∞Ä 2Îã®Í≥ÑÏóêÏÑú ÌôïÏù∏Ìïú Î∞îÎûå Íµ¨Î©ç ÏúÑÏπòÏôÄ ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.
                    </p>
                    <div class="step-tips">
                        <h4>üí° ÌïµÏã¨ Ìè¨Ïù∏Ìä∏</h4>
                        <ul>
                            <li>Îã®ÏÜåÎ•º ÏïÑÎû´ÏûÖÏà†Ïùò ÎÅù Î∂ÄÎ∂ÑÏóê ÏÇ¥Ïßù Í±∏ÏπòÎìØÏù¥ ÎåÄÍ∏∞</li>
                            <li>Îã®ÏÜåÏùò Ï∑®Íµ¨(Î∂àÍµ¨Î©ç)Í∞Ä ÏûÖÏà† Ï§ëÏïô, Î∞îÎûå Íµ¨Î©çÍ≥º ÏùºÏßÅÏÑ†Ïù∏ÏßÄ ÌôïÏù∏ÌïòÍ∏∞</li>
                            <li>ÎÑàÎ¨¥ ÏÑ∏Í≤å ÎàÑÎ•¥ÏßÄ ÎßêÍ≥† Í∞ÄÎ≥çÍ≤å ÎåÄÍ∏∞</li>
                            <li>Îã®ÏÜåÎ•º ÏàòÌèâÏúºÎ°ú Ïú†ÏßÄÌïòÎ©∞ Î™∏ÏóêÏÑú ÏïΩÍ∞Ñ ÏïûÏ™ΩÏúºÎ°ú Í∏∞Ïö∏Ïù¥Í∏∞ (ÏïΩ 30~45ÎèÑ)</li>
                        </ul>
                    </div>
                </div>

                <div class="step-card">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-title">ÏÜåÎ¶¨ÎÇ¥Î≥¥Í∏∞</div>
                    </div>
                    <p class="step-description">
                        Îã®ÏÜåÎ•º ÏÉÅÌïòÏ¢åÏö∞Î°ú Ï≤úÏ≤úÌûà ÏõÄÏßÅÏù¥Î©¥ÏÑú ÏÜåÎ¶¨Í∞Ä ÎÇòÎäî ÏµúÏ†ÅÏùò ÏúÑÏπòÎ•º Ï∞æÏäµÎãàÎã§.
                        Í≥µÍ∏∞Í∞Ä Ï∑®Íµ¨Î•º ÌÜµÌï¥ Ï†àÎ∞òÏùÄ ÏïàÏúºÎ°ú, Ï†àÎ∞òÏùÄ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÎèÑÎ°ù Í∞ÅÎèÑÎ•º Ï°∞Ï†àÌïòÏÑ∏Ïöî.
                    </p>
                    <div class="step-tips">
                        <h4>üí° ÌïµÏã¨ Ìè¨Ïù∏Ìä∏</h4>
                        <ul>
                            <li>Îã®ÏÜåÎ•º ÏúÑÏïÑÎûòÎ°ú 1~2mmÏî© Ï≤úÏ≤úÌûà ÏõÄÏßÅÏù¥Î©∞ ÏÜåÎ¶¨ ÎÇòÎäî ÏßÄÏ†ê Ï∞æÍ∏∞</li>
                            <li>Ï¢åÏö∞Î°úÎèÑ ÎØ∏ÏÑ∏ÌïòÍ≤å Ï°∞Ï†ïÌïòÎ©∞ Í∞ÄÏû• ÎßëÏùÄ ÏÜåÎ¶¨Í∞Ä ÎÇòÎäî ÏúÑÏπò Ï∞æÍ∏∞</li>
                            <li>Í≥µÍ∏∞ Î∞©Ìñ•: Ï∑®Íµ¨Ïóê Ï†àÎ∞òÏùÄ Îì§Ïñ¥Í∞ÄÍ≥† Ï†àÎ∞òÏùÄ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÎèÑÎ°ù</li>
                            <li>Ï≤òÏùåÏóî "Ïä§~" ÏÜåÎ¶¨Í∞Ä ÎÇòÎã§Í∞Ä, Í∞ÅÎèÑÍ∞Ä ÎßûÏúºÎ©¥ ÎßëÏùÄ ÏùåÏù¥ ÎÇòÏòµÎãàÎã§</li>
                            <li>ÎßàÏù¥ÌÅ¨Î•º ÏºúÏÑú ÏÜåÎ¶¨ Î∂ÑÏÑù Í∏∞Îä•ÏúºÎ°ú ÏùåÎÜíÏù¥ ÌôïÏù∏ÌïòÍ∏∞</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Ï∞∏Í≥† ÏòÅÏÉÅ -->
            <div class="card instructions">
                <h2>üé¨ Ï∞∏Í≥† ÏòÅÏÉÅ</h2>
                <div class="video-links">
                    <div class="video-link-card">
                        <a href="https://www.youtube.com/watch?v=4U_cOC6f66A" target="_blank">
                            <h3>Îã®ÏÜå Ïó∞Ï£ºÎ≤ï Í∏∞Ï¥à</h3>
                            <p>Îã®ÏÜåÏùò Ïò¨Î∞îÎ•∏ ÏûêÏÑ∏ÏôÄ ÏÜåÎ¶¨ ÎÇ¥Îäî Î∞©Î≤ïÏùÑ Î∞∞Ïö∏ Ïàò ÏûàÏäµÎãàÎã§.</p>
                            <span class="btn">‚ñ∂ ÏòÅÏÉÅ Î≥¥Í∏∞</span>
                        </a>
                    </div>
                    <div class="video-link-card">
                        <a href="https://www.youtube.com/watch?v=lvy6FA-PyC0" target="_blank">
                            <h3>Îã®ÏÜå Ïó∞Ï£º Í∞ÄÏù¥Îìú</h3>
                            <p>Îã®ÏÜå Ïó∞Ï£ºÏùò ÏÑ∏Î∂Ä Í∏∞Î≤ïÍ≥º ÌåÅÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
                            <span class="btn">‚ñ∂ ÏòÅÏÉÅ Î≥¥Í∏∞</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TensorFlow.js Î∞è FaceMesh ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.2"></script>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let video, canvas, ctx, detector;
        let audioContext, analyser, microphone, dataArray;
        let animationId;
        let isDetecting = false;
        let isAnalyzing = false;
        let videoStream = null;
        let audioStream = null;

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            video = document.getElementById('webcam');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('stopCamera').addEventListener('click', stopCamera);
            document.getElementById('startAudio').addEventListener('click', startAudio);
            document.getElementById('stopAudio').addEventListener('click', stopAudio);
        });

        // Ïπ¥Î©îÎùº ÏãúÏûë
        async function startCamera() {
            const startBtn = document.getElementById('startCamera');
            const stopBtn = document.getElementById('stopCamera');
            const statusIndicator = document.getElementById('cameraStatus');

            try {
                startBtn.disabled = true;
                startBtn.textContent = 'Î°úÎî© Ï§ë...';

                // ÏõπÏ∫† Ïä§Ìä∏Î¶º Í∞ÄÏ†∏Ïò§Í∏∞
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = videoStream;

                // ÎπÑÎîîÏò§ Î°úÎìú ÎåÄÍ∏∞
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });

                // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // FaceMesh Î™®Îç∏ Î°úÎìú
                statusIndicator.classList.remove('active');
                startBtn.textContent = 'AI Î™®Îç∏ Î°úÎî© Ï§ë...';

                detector = await faceLandmarksDetection.createDetector(
                    faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
                    {
                        runtime: 'tfjs',
                        refineLandmarks: true,
                        maxFaces: 1
                    }
                );

                statusIndicator.classList.add('active');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                isDetecting = true;

                // Í∞êÏßÄ ÏãúÏûë
                detectFace();

            } catch (error) {
                console.error('Ïπ¥Î©îÎùº ÏãúÏûë Ïò§Î•ò:', error);
                alert('Ïπ¥Î©îÎùºÎ•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                startBtn.disabled = false;
                startBtn.textContent = 'Ïπ¥Î©îÎùº ÏãúÏûë';
            }
        }

        // Ïπ¥Î©îÎùº Ï§ëÏßÄ
        function stopCamera() {
            const startBtn = document.getElementById('startCamera');
            const stopBtn = document.getElementById('stopCamera');
            const statusIndicator = document.getElementById('cameraStatus');

            // ÏñºÍµ¥ Í∞êÏßÄ Ï§ëÏßÄ
            isDetecting = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            // ÎπÑÎîîÏò§ Ïä§Ìä∏Î¶º Ï§ëÏßÄ
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            // ÎπÑÎîîÏò§ ÏÜåÏä§ Ï†úÍ±∞
            video.srcObject = null;

            // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            statusIndicator.classList.remove('active');
            startBtn.classList.remove('hidden');
            startBtn.disabled = false;
            startBtn.textContent = 'Ïπ¥Î©îÎùº ÏãúÏûë';
            stopBtn.classList.add('hidden');

            // ÌîºÎìúÎ∞± Ï¥àÍ∏∞Ìôî
            document.getElementById('lipFeedback').innerHTML = '';
        }

        // ÏñºÍµ¥ Í∞êÏßÄ Î∞è Î∂ÑÏÑù
        async function detectFace() {
            if (!isDetecting) return;

            try {
                const faces = await detector.estimateFaces(video);

                // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (faces.length > 0) {
                    const face = faces[0];
                    const keypoints = face.keypoints;

                    // ÏûÖÏà† Í¥ÄÎ†® ÎûúÎìúÎßàÌÅ¨ Í∑∏Î¶¨Í∏∞
                    drawLipLandmarks(keypoints);

                    // ÏûÖÏà† Î∂ÑÏÑù
                    analyzeLipShape(keypoints);
                }

            } catch (error) {
                console.error('ÏñºÍµ¥ Í∞êÏßÄ Ïò§Î•ò:', error);
            }

            animationId = requestAnimationFrame(detectFace);
        }

        // ÏûÖÏà† ÎûúÎìúÎßàÌÅ¨ Í∑∏Î¶¨Í∏∞
        function drawLipLandmarks(keypoints) {
            // ÏûÖÏà† Ïô∏Í≥ΩÏÑ† Ïù∏Îç±Ïä§ (MediaPipe FaceMesh)
            const upperLip = [61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291];
            const lowerLip = [146, 91, 181, 84, 17, 314, 405, 321, 375, 291];
            const lipCorners = [61, 291]; // ÏûÖÍº¨Î¶¨

            // ÏúóÏûÖÏà† Í∑∏Î¶¨Í∏∞
            ctx.strokeStyle = '#48bb78';
            ctx.lineWidth = 2;
            ctx.beginPath();
            upperLip.forEach((idx, i) => {
                const point = keypoints[idx];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();

            // ÏïÑÎû´ÏûÖÏà† Í∑∏Î¶¨Í∏∞
            ctx.strokeStyle = '#667eea';
            ctx.beginPath();
            lowerLip.forEach((idx, i) => {
                const point = keypoints[idx];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();

            // ÏûÖÍº¨Î¶¨ Í∞ïÏ°∞
            ctx.fillStyle = '#ed8936';
            lipCorners.forEach(idx => {
                const point = keypoints[idx];
                ctx.beginPath();
                ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                ctx.fill();
            });

            // ÏûÖ Ï§ëÏïô ÌëúÏãú
            const center = keypoints[13]; // ÏûÖ Ï§ëÏïô
            ctx.fillStyle = '#f56565';
            ctx.beginPath();
            ctx.arc(center.x, center.y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        // ÏûÖÏà† Î™®Ïñë Î∂ÑÏÑù
        function analyzeLipShape(keypoints) {
            const feedback = document.getElementById('lipFeedback');
            const feedbackItems = [];

            // ÏûÖÏà† ÎÑàÎπÑ Í≥ÑÏÇ∞
            const leftCorner = keypoints[61];
            const rightCorner = keypoints[291];
            const lipWidth = Math.sqrt(
                Math.pow(rightCorner.x - leftCorner.x, 2) +
                Math.pow(rightCorner.y - leftCorner.y, 2)
            );

            // ÏûÖÏà† ÎÜíÏù¥ Í≥ÑÏÇ∞
            const upperLip = keypoints[0];
            const lowerLip = keypoints[17];
            const lipHeight = Math.sqrt(
                Math.pow(lowerLip.x - upperLip.x, 2) +
                Math.pow(lowerLip.y - upperLip.y, 2)
            );

            // ÏûÖÏà† Ï¢ÖÌö°ÎπÑ
            const aspectRatio = lipWidth / lipHeight;

            // ÏûÖÏà† ÎÑàÎπÑ ÌîºÎìúÎ∞±
            if (aspectRatio > 4.0) {
                feedbackItems.push({
                    type: 'good',
                    title: '‚úì ÏûÖÏà† Î™®Ïñë Ï¢ãÏùå',
                    text: 'ÏûÖÏà†Ïù¥ ÎÑìÍ≤å Ìé¥Ï†∏ ÏûàÏäµÎãàÎã§. Ï¢ãÏùÄ ÏûêÏÑ∏ÏûÖÎãàÎã§!'
                });
            } else if (aspectRatio > 3.0) {
                feedbackItems.push({
                    type: 'warning',
                    title: '‚ö† ÏûÖÏà†ÏùÑ Îçî Ìé¥ÏÑ∏Ïöî',
                    text: 'ÏûÖÏà†ÏùÑ ÏñëÏòÜÏúºÎ°ú Ï°∞Í∏à Îçî ÎÑìÍ≤å Ìé¥Î≥¥ÏÑ∏Ïöî.'
                });
            } else {
                feedbackItems.push({
                    type: 'error',
                    title: '‚úó ÏûÖÏà†Ïù¥ Ï¢ÅÏäµÎãàÎã§',
                    text: '"Ìúò" Î∞úÏùåÌïòÎìØÏù¥ ÏûÖÏà†ÏùÑ ÏñëÏòÜÏúºÎ°ú ÎÑìÍ≤å Ìé¥ÏÑ∏Ïöî.'
                });
            }

            // ÏûÖ Î≤åÎ¶º Ï†ïÎèÑ ÌîºÎìúÎ∞±
            if (lipHeight < 15) {
                feedbackItems.push({
                    type: 'good',
                    title: '‚úì ÏûÖ Î≤åÎ¶º Ï†ÅÏ†à',
                    text: 'ÏûÖÏùÑ ÎÑàÎ¨¥ Î≤åÎ¶¨ÏßÄ ÏïäÍ≥† ÏûàÏäµÎãàÎã§.'
                });
            } else {
                feedbackItems.push({
                    type: 'warning',
                    title: '‚ö† ÏûÖÏùÑ Ï°∞Í∏à Îã´ÏúºÏÑ∏Ïöî',
                    text: 'ÏûÖÏùÑ ÎÑàÎ¨¥ Î≤åÎ¶¨ÏßÄ ÎßàÏÑ∏Ïöî. ÏÇ¥ÏßùÎßå Î≤åÎ¶¨Î©¥ Îê©ÎãàÎã§.'
                });
            }

            // ÏûÖÍº¨Î¶¨ Í∏¥Ïû•ÎèÑ ÌôïÏù∏ (Í∞ÅÎèÑ Í≥ÑÏÇ∞)
            const leftY = leftCorner.y;
            const rightY = rightCorner.y;
            const yDiff = Math.abs(leftY - rightY);

            if (yDiff < 5) {
                feedbackItems.push({
                    type: 'good',
                    title: '‚úì ÏûÖÍº¨Î¶¨ ÏàòÌèâ',
                    text: 'ÏûÖÍº¨Î¶¨Í∞Ä ÏàòÌèâÏùÑ Ïú†ÏßÄÌïòÍ≥† ÏûàÏäµÎãàÎã§.'
                });
            } else {
                feedbackItems.push({
                    type: 'warning',
                    title: '‚ö† ÏûÖÍº¨Î¶¨ Ï°∞Ï†ï',
                    text: 'ÏûÖÍº¨Î¶¨Î•º ÏàòÌèâÏúºÎ°ú Ïú†ÏßÄÌïòÏÑ∏Ïöî.'
                });
            }

            // ÌîºÎìúÎ∞± UI ÏóÖÎç∞Ïù¥Ìä∏
            feedback.innerHTML = feedbackItems.map(item => `
                <div class="feedback-item ${item.type}">
                    <h3>${item.title}</h3>
                    <p>${item.text}</p>
                </div>
            `).join('');
        }

        // Ïò§ÎîîÏò§ ÏãúÏûë
        async function startAudio() {
            const startBtn = document.getElementById('startAudio');
            const stopBtn = document.getElementById('stopAudio');
            const statusIndicator = document.getElementById('micStatus');

            try {
                startBtn.disabled = true;
                startBtn.textContent = 'Î°úÎî© Ï§ë...';

                // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // ÎßàÏù¥ÌÅ¨ Ïä§Ìä∏Î¶º Í∞ÄÏ†∏Ïò§Í∏∞
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(audioStream);
                microphone.connect(analyser);

                statusIndicator.classList.add('active');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                isAnalyzing = true;

                // Ïò§ÎîîÏò§ Î∂ÑÏÑù ÏãúÏûë
                analyzeAudio();

            } catch (error) {
                console.error('ÎßàÏù¥ÌÅ¨ ÏãúÏûë Ïò§Î•ò:', error);
                alert('ÎßàÏù¥ÌÅ¨Î•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                startBtn.disabled = false;
                startBtn.textContent = 'ÎßàÏù¥ÌÅ¨ ÏãúÏûë';
            }
        }

        // Ïò§ÎîîÏò§ Ï§ëÏßÄ
        function stopAudio() {
            const startBtn = document.getElementById('startAudio');
            const stopBtn = document.getElementById('stopAudio');
            const statusIndicator = document.getElementById('micStatus');

            // Ïò§ÎîîÏò§ Î∂ÑÏÑù Ï§ëÏßÄ
            isAnalyzing = false;

            // ÎßàÏù¥ÌÅ¨ Ïó∞Í≤∞ Ìï¥Ï†ú
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }

            // Ïò§ÎîîÏò§ Ïä§Ìä∏Î¶º Ï§ëÏßÄ
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ Îã´Í∏∞
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // ÏãúÍ∞ÅÌôî Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
            const visualCanvas = document.getElementById('audioVisualization');
            const visualCtx = visualCanvas.getContext('2d');
            visualCtx.fillStyle = 'rgb(0, 0, 0)';
            visualCtx.fillRect(0, 0, visualCanvas.width, visualCanvas.height);

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            statusIndicator.classList.remove('active');
            startBtn.classList.remove('hidden');
            startBtn.disabled = false;
            startBtn.textContent = 'ÎßàÏù¥ÌÅ¨ ÏãúÏûë';
            stopBtn.classList.add('hidden');

            // ÌîºÎìúÎ∞± Ï¥àÍ∏∞Ìôî
            document.getElementById('pitchDisplay').textContent = 'ÏùåÎÜíÏù¥: --';
            document.getElementById('audioFeedback').innerHTML = '';
        }

        // Ïò§ÎîîÏò§ Î∂ÑÏÑù
        function analyzeAudio() {
            if (!isAnalyzing) return;

            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(dataArray);

            // ÏãúÍ∞ÅÌôî Í∑∏Î¶¨Í∏∞
            drawAudioVisualization();

            // ÏùåÎÜíÏù¥ Í∞êÏßÄ
            const pitch = detectPitch();

            // ÏÜåÎ¶¨ Î†àÎ≤® Í∞êÏßÄ
            const volume = getVolume();

            // ÌîºÎìúÎ∞± Ï†úÍ≥µ
            provideAudioFeedback(pitch, volume);

            requestAnimationFrame(analyzeAudio);
        }

        // Ïò§ÎîîÏò§ ÏãúÍ∞ÅÌôî
        function drawAudioVisualization() {
            const visualCanvas = document.getElementById('audioVisualization');
            const visualCtx = visualCanvas.getContext('2d');
            const WIDTH = visualCanvas.width;
            const HEIGHT = visualCanvas.height;

            analyser.getByteFrequencyData(dataArray);

            visualCtx.fillStyle = 'rgb(0, 0, 0)';
            visualCtx.fillRect(0, 0, WIDTH, HEIGHT);

            const barWidth = (WIDTH / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                barHeight = (dataArray[i] / 255) * HEIGHT;

                const gradient = visualCtx.createLinearGradient(0, HEIGHT - barHeight, 0, HEIGHT);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');

                visualCtx.fillStyle = gradient;
                visualCtx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        // ÏùåÎÜíÏù¥ Í∞êÏßÄ (ÏûêÍ∏∞ÏÉÅÍ¥Ä Ìï®Ïàò ÏÇ¨Ïö©)
        function detectPitch() {
            analyser.getByteTimeDomainData(dataArray);

            // AC2F (Auto-Correlation Function)
            const bufferLength = dataArray.length;
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                const value = (dataArray[i] - 128) / 128;
                sum += value * value;
            }

            if (sum === 0) return null;

            let maxCorrelation = 0;
            let maxLag = 0;

            // ÏùåÎÜíÏù¥ Î≤îÏúÑ: ÎåÄÎûµ 80Hz ~ 1000Hz
            const minLag = Math.floor(audioContext.sampleRate / 1000);
            const maxLagLimit = Math.floor(audioContext.sampleRate / 80);

            for (let lag = minLag; lag < maxLagLimit && lag < bufferLength / 2; lag++) {
                let correlation = 0;
                for (let i = 0; i < bufferLength - lag; i++) {
                    const val1 = (dataArray[i] - 128) / 128;
                    const val2 = (dataArray[i + lag] - 128) / 128;
                    correlation += val1 * val2;
                }

                if (correlation > maxCorrelation) {
                    maxCorrelation = correlation;
                    maxLag = lag;
                }
            }

            if (maxCorrelation > 0.01) {
                const frequency = audioContext.sampleRate / maxLag;
                return frequency;
            }

            return null;
        }

        // Î≥ºÎ•® Í∞êÏßÄ
        function getVolume() {
            analyser.getByteTimeDomainData(dataArray);

            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const value = (dataArray[i] - 128) / 128;
                sum += value * value;
            }

            return Math.sqrt(sum / dataArray.length);
        }

        // Ïò§ÎîîÏò§ ÌîºÎìúÎ∞±
        function provideAudioFeedback(pitch, volume) {
            const pitchDisplay = document.getElementById('pitchDisplay');
            const audioFeedback = document.getElementById('audioFeedback');
            const feedbackItems = [];

            // ÏùåÎÜíÏù¥ ÌëúÏãú
            if (pitch) {
                const noteName = getNoteName(pitch);
                pitchDisplay.innerHTML = `ÏùåÎÜíÏù¥: ${pitch.toFixed(1)} Hz<br>${noteName}`;
            } else {
                pitchDisplay.textContent = 'ÏùåÎÜíÏù¥: --';
            }

            // Î≥ºÎ•® ÌîºÎìúÎ∞±
            if (volume > 0.01) {
                if (volume > 0.1) {
                    feedbackItems.push({
                        type: 'warning',
                        title: '‚ö† ÎÑàÎ¨¥ ÌÅ∞ ÏÜåÎ¶¨',
                        text: 'Ï°∞Í∏à Îçî Î∂ÄÎìúÎüΩÍ≤å Î∂àÏñ¥Î≥¥ÏÑ∏Ïöî.'
                    });
                } else if (volume > 0.02) {
                    feedbackItems.push({
                        type: 'good',
                        title: '‚úì Ï†ÅÏ†àÌïú ÏÜåÎ¶¨',
                        text: 'Ï¢ãÏùÄ Ìò∏Ìù°ÏûÖÎãàÎã§!'
                    });
                } else {
                    feedbackItems.push({
                        type: 'warning',
                        title: '‚ö† ÏïΩÌïú ÏÜåÎ¶¨',
                        text: 'Ï°∞Í∏à Îçî Í∞ïÌïòÍ≤å Î∂àÏñ¥Î≥¥ÏÑ∏Ïöî.'
                    });
                }
            } else {
                feedbackItems.push({
                    type: 'error',
                    title: '‚úó ÏÜåÎ¶¨Í∞Ä Í∞êÏßÄÎêòÏßÄ ÏïäÏùå',
                    text: 'Îã®ÏÜåÎ•º Î∂àÏñ¥Î≥¥ÏÑ∏Ïöî.'
                });
            }

            // ÏùåÎÜíÏù¥ ÌîºÎìúÎ∞±
            if (pitch) {
                if (pitch >= 440 && pitch <= 880) {
                    feedbackItems.push({
                        type: 'good',
                        title: '‚úì ÏùåÎÜíÏù¥ Ï¢ãÏùå',
                        text: 'Îã®ÏÜåÏùò Ï†ÅÏ†àÌïú ÏùåÏó≠ÎåÄÏûÖÎãàÎã§.'
                    });
                } else if (pitch < 440) {
                    feedbackItems.push({
                        type: 'warning',
                        title: '‚ö† ÏùåÎÜíÏù¥Í∞Ä ÎÇÆÏùå',
                        text: 'ÏûÖÍπÄÏùÑ Ï°∞Í∏à Îçî Í∞ïÌïòÍ≤å Î∂àÏñ¥Î≥¥ÏÑ∏Ïöî.'
                    });
                } else {
                    feedbackItems.push({
                        type: 'warning',
                        title: '‚ö† ÏùåÎÜíÏù¥Í∞Ä ÎÜíÏùå',
                        text: 'ÏûÖÍπÄÏùÑ Ï°∞Í∏à Îçî Î∂ÄÎìúÎüΩÍ≤å Ï°∞Ï†àÌï¥Î≥¥ÏÑ∏Ïöî.'
                    });
                }
            }

            // ÌîºÎìúÎ∞± UI ÏóÖÎç∞Ïù¥Ìä∏
            audioFeedback.innerHTML = feedbackItems.map(item => `
                <div class="feedback-item ${item.type}">
                    <h3>${item.title}</h3>
                    <p>${item.text}</p>
                </div>
            `).join('');
        }

        // Ï£ºÌååÏàòÎ•º Îã®ÏÜå ÏùåÍ≥ÑÎ°ú Î≥ÄÌôò
        function getNoteName(frequency) {
            // ÌïúÍµ≠ Ï†ÑÌÜµ Ïã≠Ïù¥Ïú®Î™Ö (12Ïú®Î™Ö) - Í∞ÑÎã® ÌëúÍ∏∞
            const koreanNotes = [
                { western: 'C', name: 'Ìô©' },
                { western: 'C#', name: 'ÎåÄ' },
                { western: 'D', name: 'ÌÉú' },
                { western: 'D#', name: 'Ìòë' },
                { western: 'E', name: 'Í≥†' },
                { western: 'F', name: 'Ï§ë' },
                { western: 'F#', name: 'Ïú†' },
                { western: 'G', name: 'ÏûÑ' },
                { western: 'G#', name: 'Ïù¥' },
                { western: 'A', name: 'ÎÇ®' },
                { western: 'A#', name: 'Î¨¥' },
                { western: 'B', name: 'Ïùë' }
            ];

            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);

            const halfSteps = 12 * Math.log2(frequency / C0);
            const noteIndex = Math.round(halfSteps) % 12;
            const octave = Math.floor(halfSteps / 12);

            const note = koreanNotes[noteIndex];

            // Îã®ÏÜåÏùò Ï£ºÏöî ÏùåÏó≠ ÌëúÏãú (G4~E5Í∞Ä Í∏∞Î≥∏ ÏùåÏó≠)
            let dansoPosition = '';
            if (octave === 4) {
                if (note.western === 'G') dansoPosition = ' (Á≠íÈü≥)';
                else if (note.western === 'A') dansoPosition = ' (1Í≥µ)';
                else if (note.western === 'B') dansoPosition = ' (2Í≥µ)';
            } else if (octave === 5) {
                if (note.western === 'C') dansoPosition = ' (3Í≥µ)';
                else if (note.western === 'D') dansoPosition = ' (4Í≥µ)';
                else if (note.western === 'E') dansoPosition = ' (5Í≥µ)';
            }

            return `${note.name}${dansoPosition}`;
        }
    </script>
</body>
</html>
